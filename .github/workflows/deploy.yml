name: deploy
on:
  push:
    branches:
      - main
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code.
        uses: actions/checkout@main
      - name: Cache node modules
        uses: actions/cache@v1
        with:
          path: node_modules
          key: ${{ runner.OS }}-build-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.OS }}-build-
            ${{ runner.OS }}-
      - name: Install dependencies
        run: npm install
      - name: Run build
        run: npm run build
      - name: Run export
        run: npm run export
      # - name: Set up Ruby 2.6
      #   uses: actions/setup-ruby@v1
      #   with:
      #     ruby-version: 2.6
      # - name: Install bundler
      #   run: gem install bundler
      # - name: Run bundle install
      #   run: bundle install
      # - name: Build scss
      #   run: gulp styles && gulp scripts
      # - name: Build _site
      #   run: bundle exec jekyll build
      - name: SHOW AWS CLI VERSION
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_EC2_METADATA_DISABLED: true
        run: |
          aws --version
      - name: Sync Bucket
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_EC2_METADATA_DISABLED: true
        run: |
          aws s3 sync ./dist s3://s3-cloudfront2
        # run: |
        #   aws s3 sync ./dist\
        #     --region ap-northeast-2 \
        #     _site s3://s3-cloudfront2 \
        #     --delete
      - name: Invalidate Cache
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_EC2_METADATA_DISABLED: true
        run: |
          aws cloudfront create-invalidation --profile=s3-cloudfront --distribution-id {{ secrets.AWS_CLOUDFRONT_DISTRIBUTION_ID }} --paths /*
        # run: |
        #   aws cloudfront create-invalidation \
        #   --distribution-id {{ secrets.AWS_CLOUDFRONT_DISTRIBUTION_ID }} \
        #   --paths "/*"
